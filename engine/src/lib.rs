pub mod board;
pub mod engine;
mod move_sorter;
pub mod opening_book;
mod transposition_table;

use paste::paste;

macro_rules! generate_eval_tests {
    ($($encoded_board:expr => $expected_score:expr),* $(,)?) => {
        paste! {
            $(
                #[test]
                fn [<score_test_case_ $encoded_board>]() {
                    let mut engine = crate::engine::Engine::new();
                    let board = $encoded_board.parse().unwrap();
                    let score = engine.score(board);

                    assert_eq!(
                        score,
                        $expected_score,
                        "Failed board: {}",
                        $encoded_board
                    );
                }
            )*
        }
    };
}

generate_eval_tests! {
    "2252576253462244111563365343671351441" => -1,
    "7422341735647741166133573473242566" => 1,
    "23163416124767223154467471272416755633" => 0,
    "71255763773133525731261364622167124446454" => 0,
    "65214673556155731566316327373221417" => -1,
    "52677675164321472411331752454" => 0,
    "3135151421347443544172316522225776773566" => 0,
    "562154564361751726662253737734213275114" => 0,
    "233377345754465174223731671122611552" => 1,
    "6763525635134453444361412671365712" => -1,
    "211376455663355325112113664364524722" => 0,
    "3146762114467714356347741621375222" => -1,
    "67152117737262713366376314254" => 6,
    "2762751722231276466633475674533" => 5,
    "3642756176227637211322113551637574556" => 2,
    "22647455554314246733661634615122372377511" => 0,
    "427566236745127177115664464254" => 2,
    "7172212567451542223676134464437761515" => 0,
    "641154574541323641152467137655232232366" => 0,
    "5775265212657176476365522624313714333" => 2,
    "3575316255751336464276636772271112" => -3,
    "75662564375666511575212332122171447733" => 1,
    "3576127617575661522124647446257235344113" => 0,
    "655651721435342216255374674123" => 4,
    "335413424327172446337172625415575517" => 1,
    "12156756715535615116237724723" => -2,
    "4744236462134233111155374771566655522" => -1,
    "144324431445513573673777361765615215226" => 0,
    "466337133772221726726511133452571" => 0,
    "5577777735365512235162362241426611" => -3,
    "6274476136716665132411555412333345" => 0,
    "2166166176633734115273317322475724" => -2,
    "3432357517256661231652672362571175" => 3,
    "26512741647245111351472255277" => -5,
    "3414355576455177144321543311672273" => -2,
    "112471523663662675764743257544335112741" => 0,
    "24555313265147651622632244317534477" => 3,
    "5512371662253342337574526766763245" => 3,
    "27573772361321663724362213661574" => 2,
    "3336513263356226156221176142517577574" => 2,
    "5554224333234511764415115" => 4,
    "52753311433677442422121" => 8,
    "1233722555341451114725221333" => -1,
    "271713432331713132" => -11,
    "6672375354252731116762237724" => -2,
    "763452543756455357732314" => -8,
    "662222576343651642712157" => 8,
    "3455565261655364217" => -10,
    "4661237137541742643224" => 8,
    "21253774536432517717274325" => 2,
    "715371563635542612576371" => 3,
    "4435612735531457155143" => -5,
    "3457741246677474572223453551" => 5,
    "754732466173162124726115261" => 7,
    "64115442265757253615" => 10,
    "34651743747475571565" => -9,
    "36127316172165452675422251" => 7,
    "4235245615377275211512" => -7,
    "122435527534575161761" => 10,
    "473175162213611457122724" => -7,
    "5533212164224336233241461" => 3,
    "1231426213112346726266353" => -7,
    "45277231624411643516213" => 8,
    "1667675535724753771415352132" => 1,
    "41416453222527221644" => 10,
    "1715764132212113656454" => -9,
    "651142666562345525716135112" => 2,
    "7532455277545526" => -10,
    "2737772244262123677516643354" => 0,
    "5746741223753516274755" => 8,
    "736655673445166272447546" => -7,
    "5237261635627332664143376" => 8,
    "5617131757733341415" => -8,
    "6561461362133747245312317267" => 0,
    "3111642212167362762555645527" => -2,
    "46212622667241121631756" => -8,
    "47611556754127222" => 12,
    "3262221111647466" => -12,
    "7722654117336331661371176" => 7,
    "3237735666151513515634" => -7,
    "32164625" => 11,
    "6146" => 18,
    "243335424257" => 12,
    "5512243243536" => 13,
    "22144426444" => 15,
    "265756512" => -12,
    "65444437612" => 13,
    "17516442226766" => 8,
    "7343363417254" => 14,
    "74746315233" => 15,
    "5654767662" => 13,
    "74642572132" => 15,
    "51756773145177" => -10,
    "165746146225" => -11,
    "1562527227511" => 13,
    "43745416472735" => -13,
    "42434653771434" => 9,
    "1626434452343" => 13,
    "6513243566177" => 12,
    "43623536647361" => 11,
    "35544262" => 12,
    "33375546411" => -12,
    "427631264721" => 10,
    "51615567" => 15,
    "543772563551" => 14,
    "27534134362633" => 10,
    "7234472553" => 10,
    "6126741462153" => 14,
    "4737" => 18,
    "7675456251" => 13,
    "737534232264" => -10,
    "2615522" => 17,
    "37416146447" => -9,
    "14254" => 18,
    "24657443354" => -9,
    "421125247317" => 13,
    "441672735" => 11,
    "5416317226643" => 11,
    "25545" => 18,
    "716763353724" => 13,
    "274552224131661" => 0,
    "5455174361263362" => -1,
    "2531276566711153" => 2,
    "37313333717124171162542" => 3,
    "6614446666373154" => -4,
    "24617524315172127" => 2,
    "6242432155656447531617622" => 0,
    "4642332434166445" => -2,
    "165713352355467777" => 3,
    "7441746225252552" => 2,
    "7225753363613131156611" => -3,
    "246767232112661771721576" => 1,
    "1767235667232175621774455" => 2,
    "6323454652623215" => -2,
    "1113222154334225" => 0,
    "214644735611711" => 4,
    "555317266147361" => -1,
    "52446155614451175" => -4,
    "444712564755311374" => 4,
    "27222774542216557563711" => -1,
    "71324677554451437653" => 0,
    "25734476675755361223" => -2,
    "11175617456367267331" => 0,
    "11163142533736577" => 2,
    "16633611716233262" => -3,
    "1644512363271225114" => 0,
    "745673372421446145467" => 2,
    "23663444331752227747" => -1,
    "2531433343131451454271645" => 0,
    "471451525335677414" => 2,
    "775423655217723322774542556" => 0,
    "651173365733134" => -3,
    "2521714167472245144277371" => 0,
    "215235542122662" => 5,
    "272176264461726722" => 5,
    "746173754326277" => 6,
    "6666265473321316" => -2,
    "36466712613373735727361" => 3,
    "73174513544431213" => -2,
    "754342667775736" => 2,
    "13712" => 3,
    "3246313" => -2,
    "573154743" => 2,
    "751321" => 2,
    "251" => 4,
    "13234664" => -3,
    "226763" => -2,
    "54431" => 0,
    "216634" => 0,
    "24345155" => -3,
    "722763" => 3,
    "32252276" => 3,
    "2216322" => 2,
    "6133112551" => 2,
    "527376" => 0,
    "127265363" => 3,
    "535512" => 3,
    "53476" => 2,
    "2454" => -3,
    "331236733" => 3,
    "515315" => -1,
    "27626" => 2,
    "311113447" => 2,
    "6317163774" => -1,
    "66633366" => -1,
    "2145" => 3,
    "177461" => 2,
    "52511551752" => 1,
    "153266" => 0,
    "532212" => -3,
    "44561362221" => 2,
    "5233" => 1,
    "76556662" => -2,
    "6444362" => 4,
    "564523" => -2,
    "3232716" => 2,
    "226552" => -2,
    "14316234" => 2,
    "4217" => 3,
    "772772" => 4
}

#[test]
fn test_empty_board() {
    let mut engine = crate::engine::Engine::new();
    let board = "".parse().unwrap();
    let score = engine.score(board);

    assert_eq!(score, -19);
}

#[test]
fn test_opening_book() {
    let book = crate::opening_book::OpeningBook::open("../opening-book-8").unwrap();
    let board = "12344321".parse().unwrap();
    let score = book.score(&board);
    assert_eq!(score, Some(6));
}
